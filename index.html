<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, viewport-fit=cover, shrink-to-fit=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="format-detection" content="telephone=no" />
  <title>Snake+ Telegram Mini App</title>
  <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAACXBIWXMAAAsTAAALEwEAmpwYAAABN0lEQVR4nO2WQUoDQRBFa3QhiOABvIB6AA/gCbyCRxDxAK7cuXHrTkEQQRDBhRtFEMSFIAgiKP5AQRjHpKu7Zyb9oKGZma761e+qbsiyjP+8MoAbYAqMA3NgBtwCE+AK6ABZSv0R0ANmwBJYAyvgHfgCPoF34AW4Bk6jAzjXADaBCfAEvG0A+NxrYBc4iQZwBtwBb8AG+NkC8Ln3wHY0gHPgAfj+B4DvfQAuogGcAo8/APzcZ+AkGkAfeN0AwPdOowFcAi9bAHjvEjgPGNkDXrcA8N59YC8awAXwtAHgc58C1p4DT98A+NwJ0I4G0AXmGwB87zPQjgbQAz42APjee6ATDaAPfG4A8L0PwH40gAHwvgGA7x0Bh9EAhsCqBsDvjYCjaACj+I+2APjeN+AwYOQIWNUA+L3PwEHAyBGwrgHwvXNgPxrACbCqAfC9L0A7GsAp8F0D4Huf9J8gGsAlMK8B8L0vwFk0gEvgqwbA9z4DF9EA+sC6BsD3TvWfNxrAAPiuAfC9b8BBwIXoA581AL73BWhHA7gAvmsAfO8UaEcDuAK+agB87xS4jgZwoyuZO6F/tW4JjLU35yH+AMfJfhB/ANwRAAAAAElFTkSuQmCC" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
  
  <script>
    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCz1y6iiSlg83iaJtQ2WOJ-XA5dAcM6bq8",
      authDomain: "snakeplus-df162.firebaseapp.com",
      projectId: "snakeplus-df162",
      storageBucket: "snakeplus-df162.firebasestorage.app",
      messagingSenderId: "267857364718",
      appId: "1:267857364718:web:1834d21c04bdb1a6da55ff"
    };
    
    firebase.initializeApp(firebaseConfig);
    window.firebase = firebase;
    window.db = firebase.firestore();
    console.log('‚úÖ Firebase initialized');
    
    // Global saveScore function for gameEngine
    window.saveScoreToFirebase = async function(score, rank, telegramUser) {
      if (!window.db) return { success: false, error: 'Firebase not ready' };
      
      try {
        const userId = telegramUser?.id || 'anonymous';
        const username = telegramUser?.username || telegramUser?.first_name || 'Player';
        
        await window.db.collection('scores').add({
          userId: String(userId),
          username: username,
          score: score,
          rank: rank,
          telegram_user: telegramUser ? JSON.stringify(telegramUser) : null,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          language: localStorage.getItem('snakeplus_language') || 'en'
        });
        
        console.log('‚úÖ Score saved to Firebase:', score);
        return { success: true };
      } catch (error) {
        console.error('‚ùå Firebase save error:', error);
        return { success: false, error: error.message };
      }
    };
  </script>
  
  <link rel="stylesheet" href="styles.css" id="css-link" />
  <script type="module" src="src/gameEngine.js" id="game-script"></script>

  <!-- Telegram Sticky App Mode CSS -->
  <style>
    /* Sticky App Mode - prevents swipe-to-close on Telegram 7.7+ */
    html.telegram-sticky {
      overscroll-behavior: none !important;
      -webkit-overscroll-behavior: none !important;
    }
    body.telegram-sticky {
      position: fixed;
      width: 100%;
      height: 100vh;
      height: -webkit-fill-available;
      overflow: hidden !important;
    }
  </style>

  <script>
    // Enable Telegram Sticky App Mode
    (function() {
      if (window.Telegram && window.Telegram.WebApp) {
        window.Telegram.WebApp.ready();
        window.Telegram.WebApp.expand();
        
        // Add sticky class after Telegram loads
        setTimeout(function() {
          document.documentElement.classList.add('telegram-sticky');
          document.body.classList.add('telegram-sticky');
          console.log('‚úÖ Sticky App Mode enabled');
        }, 100);
      }
    })();
    
    // Cache busting - force reload new versions
    (function() {
      const VERSION = '101-ICE-TIMER-FIX';
      const cssLink = document.getElementById('css-link');
      const gameScript = document.getElementById('game-script');

      if (cssLink) cssLink.href = `styles.css?v=${VERSION}`;
      if (gameScript) gameScript.src = `src/gameEngine.js?v=${VERSION}`;
    })();
  </script>
</head>
<body>
  <div id="game-container">
    <canvas id="game-canvas" width="400" height="400"></canvas>
    <div id="ui"></div>
  </div>
  
  <!-- Tutorial Modal -->
  <div id="tutorial-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:10000; justify-content:center; align-items:center;">
    <div style="background:linear-gradient(135deg, #1f2326 0%, #23272b 100%); border:2px solid #2ecc40; border-radius:16px; padding:24px; max-width:400px; width:90%; box-shadow:0 8px 32px rgba(46,204,64,0.3);">
      <h3 style="color:#2ecc40; text-align:center; margin:0 0 16px 0; font-size:1.4rem;">üêç How to Play</h3>
      
      <div style="margin-bottom:16px;">
        <div style="display:flex; align-items:center; gap:12px; margin-bottom:12px;">
          <span style="font-size:1.5rem;">üéÆ</span>
          <div style="color:#fff; font-size:0.95rem;"><b>Swipe</b> or <b>arrows</b> to change direction</div>
        </div>
        <div style="display:flex; align-items:center; gap:12px; margin-bottom:12px;">
          <span style="font-size:1.5rem;">üçé</span>
          <div style="color:#fff; font-size:0.95rem;">Eat <b>food</b> to grow and score</div>
        </div>
        <div style="display:flex; align-items:center; gap:12px; margin-bottom:12px;">
          <span style="font-size:1.5rem;">‚ùÑÔ∏è</span>
          <div style="color:#fff; font-size:0.95rem;"><b>Ice</b> makes you slide!</div>
        </div>
        <div style="display:flex; align-items:center; gap:12px; margin-bottom:12px;">
          <span style="font-size:1.5rem;">‚≠ê</span>
          <div style="color:#fff; font-size:0.95rem;">Collect <b>stars</b> for skins</div>
        </div>
      </div>
      
      <div style="border-top:1px solid rgba(255,255,255,0.1); padding-top:16px;">
        <label style="display:flex; align-items:center; gap:8px; color:#aaa; font-size:0.9rem; cursor:pointer;">
          <input type="checkbox" id="tutorial-dont-show" style="width:16px; height:16px;"/>
          Don't show again
        </label>
      </div>
      
      <button id="tutorial-start-btn" style="width:100%; margin-top:16px; padding:12px; background:linear-gradient(90deg, #2ecc40 0%, #27ae38 100%); color:#fff; border:none; border-radius:8px; font-size:1rem; font-weight:bold; cursor:pointer;">Start Game üéÆ</button>
    </div>
  </div>
  
  <script>
    // Tutorial modal logic
    (function() {
      const modal = document.getElementById('tutorial-modal');
      const startBtn = document.getElementById('tutorial-start-btn');
      const dontShow = document.getElementById('tutorial-dont-show');
      
      // Check if first time
      const isFirstTime = !localStorage.getItem('snakeplus_tutorial_seen');
      
      if (isFirstTime && modal) {
        modal.style.display = 'flex';
      }
      
      if (startBtn) {
        startBtn.onclick = () => {
          if (dontShow && dontShow.checked) {
            localStorage.setItem('snakeplus_tutorial_seen', 'true');
          }
          modal.style.display = 'none';
        };
      }
    })();
  </script>
</body>
</html>
